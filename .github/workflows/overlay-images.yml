name: Overlay Images Workflow

on:
  workflow_dispatch:
    inputs:
      images_json:
        description: "Un tableau JSON contenant les paires fg_image et ad_image"
        required: true
        type: string
      resumeUrl:
        description: "n8n resume URL (automatic)"
        required: false
        type: string

jobs:
  overlay-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install opencv-python-headless numpy requests

      - name: Save JSON to file
        run: |
          cat << 'EOF' > input.json
          ${{ github.event.inputs.images_json }}
          EOF

      - name: Run Overlay Script
        env:
          SUPABASE_TOKEN: ${{ secrets.SUPABASE_TOKEN }}
        run: |
          python overlay_two_images.py --input input.json --output results.json

      - name: Send Callback to n8n (if resumeUrl provided)
        if: ${{ github.event.inputs.resumeUrl != '' }}
        run: |
          # Envoyer directement le fichier JSON généré en body de la requête
          curl -X POST "${{ github.event.inputs.resumeUrl }}" \
            -H "Content-Type: application/json" \
            -d @results.json
